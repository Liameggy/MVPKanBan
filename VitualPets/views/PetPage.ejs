<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Page</title>
</head>
<style>
    body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
    }

    h2 {
        margin-bottom: 20px;
    }

    button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #007BFF;
        color: white;
        transition: background-color 0.3s ease;
    }

    #outButton {
        position: fixed;
        top: 20px;
        right: 20px;
    }

    button:hover {
        background-color: #0056b3;
    }
</style>

<body>
    <h2>Welcome to your Pet Page, <span id="user"></span>!</h2>

    <button id="outButton" onclick="window.location.href='/'">Return</button>

    <button id="createpet">Create New Pet</button>

    <!-- Modal overlay -->
    <div id="createPetOverlay" class="hidden" role="dialog" aria-modal="true" aria-labelledby="createPetTitle"
        tabindex="-1"
        style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;">
        <div id="overlayBg" style="position:absolute;inset:0;background:rgba(0,0,0,0.5);"></div>
        <div id="createPetModal"
            style="position:relative;background:#fff;border-radius:8px;padding:20px;max-width:90vw;width:420px;box-shadow:0 10px 30px rgba(0,0,0,0.25);z-index:1001;">
            <h3 id="createPetTitle" style="margin-top:0;">Create New Pet</h3>
            <label style="display:block;margin-bottom:8px;">
                Name
                <input id="petNameInput" type="text"
                    style="width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:4px;"
                    oninput="window.currentPetName = this.value" />
            </label>
            <label style="display:block;margin-bottom:12px;">
                Type
                <select id="petTypeSelect"
                    style="width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:4px;">
                    <option value="moe">Moe</option>
                    <option value="larry">Larry</option>
                    <option value="curly">Curly</option>
                </select>
            </label>
            <div style="display:flex;gap:10px;margin-bottom:12px;">
                <label style="flex:1;">
                    Pet Color 1
                    <input id="petColorInput" type="color" value="#ff0000"
                        style="width:100%;padding:4px;margin-top:6px;border:1px solid #ccc;border-radius:4px;" />
                </label>
                <label style="flex:1;">
                    Pet Color 2
                    <input id="petSecondaryColorInput" type="color" value="#000000"
                        style="width:100%;padding:4px;margin-top:6px;border:1px solid #ccc;border-radius:4px;" />
                </label>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button id="cancelCreatePet"
                    style="padding:8px 12px;background:#6c757d;color:#fff;border:none;border-radius:4px;cursor:pointer;">Cancel</button>
                <button id="confirmCreatePet"
                    style="padding:8px 12px;background:#007BFF;color:#fff;border:none;border-radius:4px;cursor:pointer;">Create</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            function drawPetToCanvas(type) {
                const canvas = document.getElementById('petBox');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                const color1Input = document.getElementById('petColorInput');
                const color2Input = document.getElementById('petSecondaryColorInput');
                const color1 = color1Input ? color1Input.value : '#ff0000';
                const color2 = color2Input ? color2Input.value : '#000000';

                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    const hexToRgb = (hex) => {
                        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                        return result ? {
                            r: parseInt(result[1], 16),
                            g: parseInt(result[2], 16),
                            b: parseInt(result[3], 16)
                        } : null;
                    };

                    const newColor1 = hexToRgb(color1);
                    const newColor2 = hexToRgb(color2);

                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const a = data[i + 3];

                        if (a === 0) continue;

                        if (r === 255 && g === 0 && b === 0) {
                            data[i] = newColor1.r;
                            data[i + 1] = newColor1.g;
                            data[i + 2] = newColor1.b;
                        }
                        else if (r === 0 && g === 0 && b === 0) {
                            data[i] = newColor2.r;
                            data[i + 1] = newColor2.g;
                            data[i + 2] = newColor2.b;
                        }
                    }

                    ctx.putImageData(imageData, 0, 0);
                };
                img.src = 'images/' + type + '.png';
            }

            // Make drawPetToCanvas globally accessible
            window.drawPetToCanvas = drawPetToCanvas;

            const typeSelect = document.getElementById('petTypeSelect');
            const confirmBtn = document.getElementById('confirmCreatePet');

            if (confirmBtn && typeSelect) {
                confirmBtn.addEventListener('click', function () {
                    if (window.currentPetName && window.currentPetName.trim() !== '') {
                        drawPetToCanvas(typeSelect.value);
                    }
                });
            }

            // Load saved pet on page load
            function loadSavedPet() {
                const urlParams = new URLSearchParams(window.location.search);
                const username = urlParams.get('user');
                
                if (username) {
                    fetch('/api/pet/' + encodeURIComponent(username))
                        .then(response => response.json())
                        .then(pet => {
                            if (pet && pet.name) {
                                // Set the pet data
                                window.currentPetName = pet.name;
                                
                                // Update the color inputs
                                const color1Input = document.getElementById('petColorInput');
                                const color2Input = document.getElementById('petSecondaryColorInput');
                                if (color1Input) color1Input.value = pet.color1;
                                if (color2Input) color2Input.value = pet.color2;
                                
                                // Update name display
                                const container = document.getElementById('petNameContainer');
                                if (container) container.textContent = pet.name;
                                
                                // Update type select
                                const typeSelect = document.getElementById('petTypeSelect');
                                if (typeSelect) typeSelect.value = pet.type;
                                
                                // Draw the pet
                                drawPetToCanvas(pet.type);
                            }
                        })
                        .catch(error => {
                            console.error('Error loading pet:', error);
                        });
                }
            }

            // Load saved pet when page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadSavedPet);
            } else {
                loadSavedPet();
            }
        })();
    </script>

    <script>
        (function () {
            const createBtn = document.getElementById('createpet');
            const overlay = document.getElementById('createPetOverlay');
            const overlayBg = document.getElementById('overlayBg');
            const modal = document.getElementById('createPetModal');
            const cancelBtn = document.getElementById('cancelCreatePet');
            const confirmBtn = document.getElementById('confirmCreatePet');
            const nameInput = document.getElementById('petNameInput');

            function showOverlay() {
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';
                // focus first input for accessibility
                setTimeout(() => nameInput.focus(), 50);
                document.body.style.overflow = 'hidden';
            }

            function hideOverlay() {
                overlay.classList.add('hidden');
                overlay.style.display = 'none';
                document.body.style.overflow = '';
                createBtn.focus();
            }

            createBtn.addEventListener('click', showOverlay);
            cancelBtn.addEventListener('click', hideOverlay);

            // close when clicking the dark background (but not the modal)
            overlayBg.addEventListener('click', hideOverlay);

            // close on Escape
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && overlay.style.display === 'flex') hideOverlay();
            });

            // example confirm handler (replace with real logic)
            confirmBtn.addEventListener('click', function () {
                const name = nameInput.value.trim();
                const type = document.getElementById('petTypeSelect').value;
                const color1 = document.getElementById('petColorInput').value;
                const color2 = document.getElementById('petSecondaryColorInput').value;
                
                if (!name) {
                    nameInput.focus();
                    return;
                }
                
                // Get username from URL query params
                const urlParams = new URLSearchParams(window.location.search);
                const username = urlParams.get('user');
                
                if (!username) {
                    alert('User not found. Please log in again.');
                    return;
                }
                
                // Save pet to database
                fetch('/api/pet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        name: name,
                        type: type,
                        color1: color1,
                        color2: color2
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error + (err.details ? ': ' + err.details : ''));
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log('Pet saved successfully');
                        // Trigger the pet drawing
                        window.currentPetName = name;
                        const typeSelect = document.getElementById('petTypeSelect');
                        const color1Input = document.getElementById('petColorInput');
                        const color2Input = document.getElementById('petSecondaryColorInput');
                        
                        // Update the color inputs for the drawing function
                        color1Input.value = color1;
                        color2Input.value = color2;
                        
                        // Draw the pet
                        drawPetToCanvas(type);
                        
                        // Update the pet name display
                        const container = document.getElementById('petNameContainer');
                        if (container) container.textContent = name;
                        
                        hideOverlay();
                    } else {
                        alert('Failed to save pet. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error saving pet:', error);
                    alert('Error saving pet: ' + error.message);
                });
            });
        })();
    </script>

    <div id="petNameContainer" aria-live="polite" style="margin:12px 0;font-weight:600;"></div>
    <script>
        (function () {
            const container = document.getElementById('petNameContainer');
            function render(name) {
                if (name && name.trim() !== '') container.textContent = name;
                else container.textContent = '';
            }

            // initial render
            render(window.currentPetName);

            // also update when creation is confirmed
            const confirmBtn = document.getElementById('confirmCreatePet');
            if (confirmBtn) confirmBtn.addEventListener('click', () => render(window.currentPetName));
        })();
    </script>

    <canvas id="petBox" width="672" height="672"
        style="width:67vmin;height:67vmin;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);"></canvas>

    <div style="display:inline-flex; gap:10px; align-items:center;">
        <button id="playpet1" style="display:inline-block;">Pet pet</button>
        <button id="playpet2" style="display:inline-block;">Feed pet</button>
        <button id="playpet3" style="display:inline-block;">Play with pet</button>
    </div>

    <script>
        function getQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            for (const [key, value] of urlParams.entries()) {
                params[key] = value;
            }
            return params;
        }

        const queryParams = getQueryParams();
        const user = queryParams.user;
        if (user) {
            console.log("User's user from query params:", user);
        } else {
            console.log("No user parameter found in the URL.");
        }
        document.getElementById('user').textContent = user;

        document.getElementById('playpet1').addEventListener('click', function () {
            if (window.currentPetName && window.currentPetName.trim() !== '') {
                alert(window.currentPetName + ' seems happy!');
            }

        });
        document.getElementById('playpet2').addEventListener('click', function () {
            if (window.currentPetName && window.currentPetName.trim() !== '') {
                alert('You fed ' + window.currentPetName + '!');
            }
        });
        document.getElementById('playpet3').addEventListener('click', function () {
            if (window.currentPetName && window.currentPetName.trim() !== '') {
                alert('You played with ' + window.currentPetName + '!');
            }
        });
    </script>
</body>

</html>